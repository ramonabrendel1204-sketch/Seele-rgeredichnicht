<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horror MÄDN</title>
    <!-- Externe Bibliotheken -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Firebase Legacy Scripts für maximale Kompatibilität -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Nosifer&display=swap');
        body { margin: 0; background: #000; color: #f00; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .nosifer { font-family: 'Nosifer', cursive; }
        .horror { font-family: 'Creepster', cursive; }
        
        .screen {
            position: fixed; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
            background: radial-gradient(circle, #1a0000 0%, #000 100%);
            padding: 20px;
        }
        .hidden { display: none !important; }

        .btn-main {
            background: #400; border: 2px solid #800; padding: 20px;
            width: 100%; max-width: 300px; cursor: pointer; transition: 0.3s;
            text-align: center; margin: 10px; font-family: 'Nosifer'; font-size: 0.8rem;
        }
        .btn-main:hover { background: #800; border-color: #f00; box-shadow: 0 0 20px #f00; }
        
        .game-ui {
            position: fixed; inset: 0; z-index: 500; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }
        .interactive { pointer-events: auto; }
        
        #dice {
            width: 80px; height: 80px; background: #111; border: 3px solid #600;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; border-radius: 10px; cursor: pointer;
        }
        .can-roll { animation: pulse 1s infinite; border-color: #f00 !important; }
        @keyframes pulse { 50% { transform: scale(1.1); } }
    </style>
</head>
<body>

    <!-- 1. Modus Auswahl -->
    <div id="scr-mode" class="screen">
        <h1 class="nosifer text-5xl mb-12 text-center text-red-600">HORROR MÄDN</h1>
        <div id="btn-solo" class="btn-main">EINZELHAFT (Solo)</div>
        <div id="btn-multi" class="btn-main">BLUTSPAKT (Online)</div>
    </div>

    <!-- 2. Name Eingeben -->
    <div id="scr-name" class="screen hidden">
        <h2 class="nosifer mb-6">DEIN NAME</h2>
        <input type="text" id="inp-name" class="bg-black border-2 border-red-900 p-4 text-white text-center text-xl mb-6 outline-none w-full max-w-xs" placeholder="..." maxlength="12">
        <div id="btn-confirm" class="btn-main">BESTÄTIGEN</div>
    </div>

    <!-- 3. Lobby -->
    <div id="scr-lobby" class="screen hidden">
        <h2 class="nosifer mb-10">LOBBY</h2>
        <div id="lobby-slots" class="flex gap-4 mb-10"></div>
        <div id="btn-start" class="btn-main hidden">RITUAL STARTEN</div>
        <p class="horror text-xl text-zinc-500">Warten auf Seelen...</p>
    </div>

    <!-- 4. Game UI -->
    <div id="scr-game" class="game-ui hidden">
        <div class="flex justify-between interactive">
            <div id="player-stats" class="bg-black/80 p-4 border border-red-900 rounded"></div>
            <div id="log" class="text-[10px] text-zinc-500 max-w-[150px] italic">Initialisiere...</div>
        </div>
        <div class="flex flex-col items-center mb-10 interactive">
            <div id="dice" class="nosifer text-red-600">?</div>
            <p id="turn-hint" class="horror text-red-700 mt-2">DEIN ZUG</p>
        </div>
    </div>

    <script>
        // --- GLOBALE VARIABLEN ---
        let gameMode = null;
        let myName = "Unbekannter";
        let userId = "user_" + Math.random().toString(36).substr(2, 9);
        let mySlot = 0;
        let gameState = { active: false, slots: [null,null,null,null], currentPlayer: 0, lastDice: 0, log: "Start" };
        let db = null;
        let docRef = null;

        const PLAYERS = [
            { name: "Geister", color: "#ffffff" },
            { name: "Bibeln", color: "#00f0ff" },
            { name: "Schädel", color: "#bc13fe" },
            { name: "Kreuze", color: "#ff0033" }
        ];

        // --- HILFSFUNKTIONEN ---
        function show(id) {
            document.querySelectorAll('.screen, .game-ui').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- INIT ---
        window.onload = () => {
            console.log("App geladen");
            
            // Firebase Setup (Legacy Style)
            try {
                const config = JSON.parse(__firebase_config);
                firebase.initializeApp(config);
                db = firebase.firestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'horror-maedn-ultimate';
                docRef = db.collection('artifacts').doc(appId).collection('public').doc('globalState');
            } catch (e) {
                console.error("Firebase blockiert, nur Solo möglich", e);
            }

            // Event Listener
            document.getElementById('btn-solo').onclick = () => { gameMode = 'solo'; show('scr-name'); };
            document.getElementById('btn-multi').onclick = () => { gameMode = 'multi'; show('scr-name'); };
            
            document.getElementById('btn-confirm').onclick = () => {
                const val = document.getElementById('inp-name').value.trim();
                if (val) myName = val;
                
                if (gameMode === 'solo') {
                    startSolo();
                } else {
                    startMulti();
                }
            };
        };

        // --- SPIEL LOGIK ---
        function startSolo() {
            gameState.slots[0] = { uid: userId, name: myName };
            mySlot = 0;
            gameState.active = true;
            renderGame();
            show('scr-game');
        }

        async function startMulti() {
            if (!db) return alert("Multiplayer nicht verfügbar (Firebase blockiert)");
            
            try {
                await firebase.auth().signInAnonymously();
                userId = firebase.auth().currentUser.uid;

                // Slot suchen & beitreten
                await db.runTransaction(async (transaction) => {
                    const snap = await transaction.get(docRef);
                    let data = snap.exists ? snap.data() : { 
                        active: false, slots: [null,null,null,null], 
                        hostId: userId, currentPlayer: 0, lastDice: 0, log: "Lobby" 
                    };
                    
                    const idx = data.slots.findIndex(s => s === null);
                    if (idx === -1) throw "Voll";
                    
                    data.slots[idx] = { uid: userId, name: myName };
                    transaction.set(docRef, data);
                });

                show('scr-lobby');
                docRef.onSnapshot(snap => {
                    if (snap.exists) {
                        gameState = snap.data();
                        if (gameState.active) {
                            renderGame();
                            show('scr-game');
                        } else {
                            renderLobby();
                        }
                    }
                });
            } catch (e) {
                alert("Fehler: " + e);
            }
        }

        function renderLobby() {
            const container = document.getElementById('lobby-slots');
            container.innerHTML = '';
            let count = 0;
            gameState.slots.forEach((s, i) => {
                if (s) {
                    count++;
                    if (s.uid === userId) mySlot = i;
                }
                const d = document.createElement('div');
                d.className = "w-20 h-20 border-2 border-red-900 flex items-center justify-center text-[8px] nosifer text-center p-1";
                d.style.color = PLAYERS[i].color;
                d.innerText = s ? s.name : "OFFEN";
                container.appendChild(d);
            });

            const btn = document.getElementById('btn-start');
            if (gameState.hostId === userId && count >= 2) {
                btn.classList.remove('hidden');
                btn.onclick = () => docRef.update({ active: true, log: "Das Grauen beginnt!" });
            }
        }

        function renderGame() {
            const stats = document.getElementById('player-stats');
            stats.innerHTML = '';
            gameState.slots.forEach((s, i) => {
                const active = gameState.currentPlayer === i;
                const d = document.createElement('div');
                d.className = `text-[10px] nosifer mb-1 ${active ? 'text-red-500 scale-110' : 'text-zinc-700'}`;
                d.innerHTML = `<span style="color:${PLAYERS[i].color}">●</span> ${s ? s.name : 'BOT'}`;
                stats.appendChild(d);
            });

            document.getElementById('log').innerText = gameState.log;
            const dice = document.getElementById('dice');
            dice.innerText = gameState.lastDice || "?";
            
            const isMyTurn = gameState.currentPlayer === mySlot;
            document.getElementById('turn-hint').style.visibility = isMyTurn ? 'visible' : 'hidden';
            
            if (isMyTurn) {
                dice.classList.add('can-roll');
                dice.onclick = roll;
            } else {
                dice.classList.remove('can-roll');
                dice.onclick = null;
                // Bot Logik
                if ((gameMode === 'solo' || gameState.hostId === userId) && !gameState.slots[gameState.currentPlayer]) {
                    setTimeout(roll, 1500);
                }
            }
        }

        async function roll() {
            const v = Math.floor(Math.random() * 6) + 1;
            const next = (gameState.currentPlayer + 1) % 4;
            const name = gameState.slots[gameState.currentPlayer]?.name || "Bot";
            const newLog = `${name} würfelt eine ${v}.`;

            if (gameMode === 'solo') {
                gameState.lastDice = v;
                gameState.currentPlayer = next;
                gameState.log = newLog;
                renderGame();
            } else {
                await docRef.update({ lastDice: v, currentPlayer: next, log: newLog });
            }
        }

        // --- 3D DEKO ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        camera.position.z = 5;
        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        animate();
    </script>
</body>
</html>

